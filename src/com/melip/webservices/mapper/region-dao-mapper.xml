<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 地域サービス用 -->
<mapper namespace="com.melip.webservices.mapper.Region">

  <!-- 地域DTO用resultMap -->
  <resultMap id="regionDtoResultMap" type="com.melip.webservices.dto.region.RegionDto">
    <id property="regionId" column="regionId" />
    <collection property="attrDtoList" ofType="com.melip.common.dto.common.AttrDto">
      <id property="attrGrpId" column="attrGrpId" />
      <result property="regionId" column="regionId" />
      <result property="attrGrpType" column="attrGrpType" />
      <result property="attrGrpNm" column="attrGrpNm" />
      <result property="attrVal" column="attrVal" />
      <result property="attrCdVal" column="attrCdVal" />
    </collection>
  </resultMap>

  <!-- ステータスの条件 -->
  <sql id="stsCondition">
    in
    <foreach collection="stsArray" item="item" open="(" separator="," close=")">
      #{item}
    </foreach>
  </sql>

  <!-- 言語区分の条件 -->
  <sql id="langDivCondition">
    in
    <foreach collection="langDivArray" item="item" open="(" separator="," close=")">
      #{item}
    </foreach>
  </sql>
  
  <!-- 地域情報取得 -->
  <select id="selectRegion" resultMap="regionDtoResultMap" parameterType="CONDITION"
    useCache="false">

    select
        a.REGION_ID          as regionId
      , a.REGION_ATTR_GRP_ID as attrGrpId
      , a.TYPE               as attrGrpType
      , a.NM                 as attrGrpNm
      , case 
        when cd1.CD_NM is null 
        then a.val 
        else cd1.CD_NM 
        end                  as attrVal
      , case 
        when cd1.cd_nm is null 
        then null 
        else a.VAL 
        end                  as attrCdVal 
    from
      ( 
        select
            r.REGION_ID
          , rag.REGION_ATTR_GRP_ID
          , ragl.NM
          , ravl.VAL
          , rag.TYPE
          , rag.CD_GRP_ID 
        from
          m_region r 
          inner join m_region_attr_val rav 
            on r.REGION_ID = rav.REGION_ID 
            and rav.STS <include refid="stsCondition"/> 
          inner join m_region_attr_val_lang ravl 
            on rav.REGION_ATTR_VAL_ID = ravl.REGION_ATTR_VAL_ID 
            and ravl.LANG_DIV <include refid="langDivCondition"/>  
            and ravl.STS <include refid="stsCondition"/> 
          inner join m_region_attr_grp rag 
            on rav.REGION_ATTR_GRP_ID = rag.REGION_ATTR_GRP_ID 
            and rag.STS <include refid="stsCondition"/> 
            <if test="v.regionAttrGrpId != null"> 
              and rag.REGION_ATTR_GRP_ID = #{v.regionAttrGrpId} 
            </if>
          inner join m_region_attr_grp_lang ragl 
            on rag.REGION_ATTR_GRP_ID = ragl.REGION_ATTR_GRP_ID 
            and ragl.LANG_DIV <include refid="langDivCondition"/>  
            and ragl.STS <include refid="stsCondition"/> 
        where
          r.STS <include refid="stsCondition"/> 
          <if test="v.regionId != null"> 
            and r.REGION_ID = #{v.regionId} 
          </if>
      ) a 
      left outer join v_cd cd1 
        on a.CD_GRP_ID = cd1.CD_GRP_ID 
        and a.VAL = cd1.CD 
        and cd1.LANG_DIV <include refid="langDivCondition"/>  
    order by
      a.REGION_ID
      , a.REGION_ATTR_GRP_ID

  </select>

</mapper>